<h3 id="intro">1. Introduction</h3>
<p>
    Nous avons r√©cemment travaill√© sur un projet qui consiste en une application web, d√©velopp√©e en PHP pour g√©rer des photos et des albums photos.
    Cette application permet √† un utilisateur de se connecter, de cr√©er des albums, d'ajouter des photos √† ses albums, de les modifier et de les supprimer.
    Nous pouvons √©galement ajouter la possibilit√© de taguer les photos avec des mots-cl√©s pour les organiser.
</p>
<p>
    Pour faire √©voluer notre application et l'am√©liorer, nous allons lui adjoindre une base de donn√©es pour stocker les donn√©es des utilisateurs, 
    des albums et des photos et √©ventuellement des tags. Nous allons √©galement √©tudier les requ√™tes SQL pour effectuer des op√©rations sur ces donn√©es.
</p>
<p>
    Pour stocker les donn√©es de notre galerie de photos, nous allons utiliser une base de donn√©es. Nous allons cr√©er une base de donn√©es 
    <code>galerie_photos</code> contenant plusieurs tables :

    <ul>
        <li>La table <code>utilisateurs</code> pour stocker les informations des utilisateurs (nom, email, mot de passe, date de cr√©ation)</li>
        <li>La table <code>albums</code> pour stocker les informations des albums (nom, description, date de cr√©ation)</li>
        <li>La table <code>photos</code> pour stocker les informations des photos (titre, description, chemin du fichier, date d'ajout)</li>
        <li>La table <code>tags</code> pour stocker les mots-cl√©s des photos (facultatif)</li>
        <li>La table <code>photo_tags</code> pour lier les photos aux tags (facultatif)</li>
    </ul>   
</p>
<p> 
    Nous allons en premier lieu utiliser les applications de gestion telles que phpMyAdmin et DBeaver pour travailler sur cette base de donn√©es,
    autrement dit pour ajouter, modifier, supprimer et afficher les donn√©es de notre galerie de photos. <br>
    Nous √©tudierons √©galement les requ√™tes SQL pour effectuer des op√©rations sur les donn√©es stock√©es dans la base de donn√©es. <br>
    Avant toute chose nous allons cr√©er la base de donn√©es et les tables n√©cessaires pour stocker les donn√©es de notre galerie de photos. <br>
    Analysons le script SQL suivant.
</p>

<h3 id="script">2. Le script SQL</h3>
<textarea class="code-php">
CREATE DATABASE galerie_photos CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE galerie_photos;

-- Table des utilisateurs (si n√©cessaire)
CREATE TABLE utilisateurs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    mot_de_passe VARCHAR(255) NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Table des albums
CREATE TABLE albums (
    id INT AUTO_INCREMENT PRIMARY KEY,
    utilisateur_id INT, -- Si chaque utilisateur a ses propres albums
    nom VARCHAR(255) NOT NULL,
    description TEXT,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id) ON DELETE SET NULL
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Table des photos
CREATE TABLE photos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT NOT NULL,
    titre VARCHAR(255),
    description TEXT,
    chemin_fichier VARCHAR(255) NOT NULL, -- Stocke le chemin de la photo sur le serveur
    date_ajout TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (album_id) REFERENCES albums(id) ON DELETE CASCADE
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Table des tags (facultatif, pour organiser les photos par mot-cl√©)
CREATE TABLE tags (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50) UNIQUE NOT NULL
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Table de liaison entre photos et tags (facultatif)
CREATE TABLE photo_tags (
    photo_id INT NOT NULL,
    tag_id INT NOT NULL,
    PRIMARY KEY (photo_id, tag_id),
    FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
</textarea>   
<a class="btn btn-primary" href="files/galerie_photos.sql">Le fichier SQL pour cr√©er la base de donn√©es ainsi que les tables</a>

<div class="alert alert-info mt-4">
    <strong>[X] Information : Que signifie UNIQUE dans le champs nom de la table tags </strong> <hr>
    L'attribut <b>UNIQUE</b> dans la colonne nom de la table tags signifie que chaque valeur dans cette colonne doit √™tre unique dans toute la table. <br>
    Concr√®tement :
    <ul>
        <li>Chaque tag doit avoir un nom unique.</li>
        <li>Il n'est pas possible d'avoir deux tags avec le m√™me nom.</li>
    </ul>

    Cela permet d'√©viter les doublons et assure que chaque tag est unique dans la base de donn√©es. <br>
    Si tu veux que le tag soit unique mais sans emp√™cher l'insertion en cas de doublon, on peut  utiliser <b>INSERT IGNORE</b> ou <b>ON DUPLICATE KEY UPDATE</b>, 
    selon le comportement souhait√©. <br>
</div>
<p>
    Exemple : Tentative d'insertion de trois tag dont un tag d√©j√†.
</p>
<textarea class="code-php">
    INSERT INTO tags (nom) VALUES ('Paysage');  -- OK
    INSERT INTO tags (nom) VALUES ('Nature');   -- OK
    INSERT INTO tags (nom) VALUES ('Paysage');  -- ERREUR ! Le nom existe d√©j√†
</textarea>

<h3 id="insert">3. Insertion des donn√©es dans les tables et points d'attention</h3>
<p>
    Pour avoir une base de donn√©es fonctionnelle, il faut ins√©rer les donn√©es dans le bon ordre, en respectant les relations entre les tables. Voici comment proc√©der correctement.
</p>

<h4>1. Ins√©rer des utilisateurs</h4>
<p>
    Si l'application est multi-utilisateurs, on commence par ajouter des utilisateurs.
</p>
<textarea class="code-php" id="">
    INSERT INTO utilisateurs (nom, email, mot_de_passe) 
    VALUES 
    ('Alice Dupont', 'alice@example.com', 'motdepasse1'),
    ('Bob Martin', 'bob@example.com', 'motdepasse2');
</textarea>
<div class="alert alert-info"> [!] Point d'attention : Le mot de passe devrait √™tre hach√© en PHP (avec la fonction password_hash()).</div>

<h4>2. Ins√©rer des albums</h4>
<p>
    Chaque album doit √™tre associ√© √† un utilisateur (utilisateur_id).
</p>
<textarea class="code-php" id="">
    INSERT INTO albums (utilisateur_id, nom, description) 
    VALUES 
    (1, 'Voyage en Italie', 'Photos de mon voyage √† Rome et Venise'),
    (2, 'Nature et Paysages', 'Collection de belles photos de la nature');
</textarea>
<div class="alert alert-info">
    [!] Point d'attention : 
    <ul>
        <li>S'assurer que <b>utilisateur_id</b> existe d√©j√† dans la table utilisateurs, sinon la cl√© √©trang√®re posera un probl√®me.</li>
        <li>Si les utilisateurs ne sont pas obligatoires, il faut g√©rer les NULL.</li>
    </ul>
</div>

<h4>3. Ins√©rer des photos</h4>
<p>
    Chaque photo doit √™tre associ√©e √† un album (<b>album_id</b>) et avoir un chemin valide.
</p>
<textarea class="code-php" id="">
    INSERT INTO photos (album_id, titre, description, chemin_fichier) 
    VALUES 
    (1, 'Colis√©e', 'Photo du Colis√©e √† Rome', 'images/rome_colisee.jpg'),
    (1, 'Gondole √† Venise', 'Balade en gondole', 'images/venise_gondole.jpg'),
    (2, 'Cascade', 'Belle cascade en for√™t', 'images/cascade.jpg');
</textarea>
<div class="alert alert-info">
    [!] Point d'attention : 
    <ul>S
        <li>V√©rifier que <b>album_id</b> existe bien dans la table albums.</li>
        <li>Le champ <b>chemin_fichier</b> doit contenir un chemin valide vers l‚Äôimage stock√©e sur le serveur.</li>
    </ul>
</div>

<h4>4. Ins√©rer des tags (facultatif)</h4>
<p>
    Si on souhaite organiser les photos par tags, on peut ajouter des tags. <br>
    Les tags sont uniques et permettent de cat√©goriser les photos.
</p>
<textarea class="code-php" id="">
    INSERT INTO tags (nom) 
    VALUES 
    ('Voyage'), 
    ('Nature'), 
    ('Architecture');
</textarea>
<div class="alert alert-info">
    [!] Point d'attention : 
    <ul>
        <li>Si un tag existe d√©j√† (gr√¢ce √† UNIQUE), une erreur peut se produire.
            üëâ Utiliser <b>INSERT IGNORE</b> pour ignorer l‚Äôerreur ou <b>ON DUPLICATE KEY UPDATE</b> pour mettre √† jour l‚Äôexistant.</li>
    </ul>
    <p>Exemples :</p>
    <textarea class="code-php">
        INSERT IGNORE INTO tags (nom) VALUES ('Voyage');
    </textarea>
    <p>OU</p>
    <textarea class="code-php">
        INSERT INTO tags (nom) VALUES ('Voyage') ON DUPLICATE KEY UPDATE nom = nom;
    </textarea>
</div>

<h4>5. Associer des tags aux photos</h4>
<p>
    La table <b>photo_tags</b> fait le lien entre les photos et les tags.
</p>
<textarea class="code-php" id="">
    -- Associer les tags aux photos
    INSERT INTO photo_tags (photo_id, tag_id) 
    VALUES 
    (1, 3), -- "Colis√©e" est associ√© au tag "Architecture"
    (2, 1), -- "Gondole √† Venise" est associ√© √† "Voyage"
    (3, 2); -- "Cascade" est associ√© √† "Nature"

</textarea>
<a class="btn btn-primary" href="files/content.sql">Le fichier SQL pour cr√©er les donn√©es</a>

<div class="alert alert-info mt-4">
    [!] Point d'attention : 
    <ul>
        <li>V√©rifier que <b>photo_id</b> et <b>tag_id</b> existent dans les tables photos et tags avant l'insertion.</li>
        <li>Une m√™me photo ne doit pas √™tre associ√©e deux fois au m√™me tag (cl√© primaire <b>photo_id</b>, <b>tag_id</b> emp√™che cela).</li>
    </ul>
</div>

<h3>4. R√©sum√© des pr√©cautions</h4>
<p>
‚úÖ Respecter l‚Äôordre des insertions pour √©viter les erreurs de cl√©s √©trang√®res. <br>
‚úÖ V√©rifier l‚Äôexistence des IDs avant de les r√©f√©rencer. <br>
‚úÖ G√©rer les erreurs de doublons avec UNIQUE (INSERT IGNORE, ON DUPLICATE KEY UPDATE). <br>
‚úÖ Stocker les chemins de fichiers de fa√ßon organis√©e. <br>
‚úÖ Toujours hacher les mots de passe des utilisateurs en PHP. <br>
</p>

<h3>5. Et maintenant quelques requ√™tes SQL sur notre nouvelle DB !</h4>

<h4>1. S√©lection des donn√©es</h4>
<p>
    a) R√©cup√©rer tous les utilisateurs
</p>
<textarea class="code-php" id="">
    SELECT * FROM galerie_photos.utilisateurs;
</textarea>
<p>
    b) Afficher tous les albums avec leurs descriptions
</p>
<textarea class="code-php" id="">
    SELECT nom, description FROM galerie_photos.albums;
</textarea>
<p>
    c) Lister toutes les photos avec leur titre et leur chemin de fichier
</p>
<textarea class="code-php" id="">
    SELECT titre, chemin_fichier FROM galerie_photos.photos;
</textarea>

<h4>2. Requ√™tes avec jointures</h4>
<p>
    a) Afficher les albums avec le nom de l'utilisateur qui les a cr√©√©s
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.albums.nom AS album, galerie_photos.utilisateurs.nom AS utilisateur
    FROM galerie_photos.albums
    JOIN galerie_photos.utilisateurs ON galerie_photos.albums.utilisateur_id = galerie_photos.utilisateurs.id;
</textarea>
<p>
    b) Afficher les photos avec le nom de leur album
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.photos.titre AS photo, galerie_photos.albums.nom AS album
    FROM galerie_photos.photos
    JOIN galerie_photos.albums ON galerie_photos.photos.album_id = galerie_photos.albums.id;
</textarea>
<p>
    c) Afficher les photos et leurs tags associ√©s
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.photos.titre AS photo, galerie_photos.tags.nom AS tag
    FROM galerie_photos.photos
    JOIN galerie_photos.photo_tags ON galerie_photos.photos.id = galerie_photos.photo_tags.photo_id
    JOIN galerie_photos.tags ON galerie_photos.photo_tags.tag_id = galerie_photos.tags.id;
</textarea>

<h4>3. Requ√™tes avec filtres (WHERE)</h4>
<p>
    a) Trouver les albums appartenant √† un utilisateur sp√©cifique (ex: Alice)
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.albums.nom, galerie_photos.albums.description FROM galerie_photos.albums
    JOIN galerie_photos.utilisateurs ON galerie_photos.albums.utilisateur_id = galerie_photos.utilisateurs.id
    WHERE galerie_photos.utilisateurs.nom = 'Alice Dupont';
</textarea>
<p>
    b) Trouver toutes les photos ayant un tag sp√©cifique (ex: "Voyage")
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.photos.titre, galerie_photos.tags.nom AS tag
    FROM galerie_photos.photos
    JOIN galerie_photos.photo_tags ON galerie_photos.photos.id = galerie_photos.photo_tags.photo_id
    JOIN galerie_photos.tags ON galerie_photos.photo_tags.tag_id = galerie_photos.tags.id
    WHERE galerie_photos.tags.nom = 'Voyage';
</textarea>

<h4>4. Comptage et agr√©gation</h4>
<p>
    a) Nombre total d'albums
</p>
<textarea class="code-php" id="">
    SELECT COUNT(*) AS total_albums FROM galerie_photos.albums;
</textarea>
<p>
    b) Nombre de photos dans chaque album
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.albums.nom AS album, COUNT(galerie_photos.photos.id) AS total_photos
    FROM galerie_photos.albums
    JOIN galerie_photos.photos ON galerie_photos.albums.id = galerie_photos.photos.album_id
    GROUP BY galerie_photos.albums.id;
</textarea>
<p>
    c) Nombre de photos par tag
</p>
<textarea class="code-php" id="">
    SELECT galerie_photos.tags.nom AS tag, COUNT(galerie_photos.photo_tags.photo_id) AS total_photos
    FROM galerie_photos.tags
    JOIN galerie_photos.photo_tags ON galerie_photos.tags.id = galerie_photos.photo_tags.tag_id
    GROUP BY galerie_photos.tags.id;
</textarea>

<h4>5. Modification et suppression</h4>
<p>
    a) Modifier la description d'un album
</p>
<textarea class="code-php" id="">
    UPDATE albums
    SET description = 'Photos de mon voyage √† Rome et Venise et Pise'
    WHERE nom = 'Voyage en Italie';
</textarea>
<p>
    b) Supprimer une photo sp√©cifique (ex: "Gondole √† Venise")
</p>
<textarea class="code-php" id="">
    DELETE FROM galerie_photos.photos WHERE titre = 'Gondole √† Venise';
    -- OU en utilisant l'ID
    DELETE FROM galerie_photos.photos WHERE id = 2;

    -- Ins√©rer √† nouveau la photo supprim√©e
    INSERT INTO galerie_photos.photos (album_id, titre, description, chemin_fichier) 
    VALUES 
    (1, 'Gondole √† Venise', 'Balade en gondole', 'images/venise_gondole.jpg');    
</textarea>
<p>
    c) Supprimer un utilisateur et tous ses albums associ√©s
</p>
<textarea class="code-php" id="">
    DELETE FROM galerie_photos.utilisateurs
    WHERE nom = 'Alice Dupont';
</textarea>
<div class="alert alert-danger mt-4">
    <strong>/!\ Attention</strong> 
    <hr>
    ‚ö†Ô∏è Cela mettra <b>NULL</b> dans <b>utilisateur_id</b> des <b>albums</b> de cet utilisateur <b>√† cause de ON DELETE SET NULL dans la contrainte FOREIGN KEY</b>.
</div>



